pipeline {
    agent any

    environment {
        VENV = ".venv"
        AMF_PORT = "8000"
        SMF_PORT = "8001"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Check Environment') {
            steps {
                sh '''
                    whoami
                    python3 --version
                    robot --version || true
                '''
            }
        }

        stage('Setup Python Virtualenv') {
            steps {
                sh '''
                    cd cnf-5g-lab

                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate

                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Start AMF & SMF APIs') {
            steps {
                sh '''
                    cd cnf-5g-lab
                    . ${VENV}/bin/activate

                    nohup python3 api/amf_api.py > amf.log 2>&1 &
                    nohup python3 api/smf_api.py > smf.log 2>&1 &

                    sleep 5
                    curl http://localhost:${AMF_PORT}/health
                '''
            }
        }

        stage('Run Robot CNF Tests') {
            steps {
                sh '''
                    cd cnf-5g-lab
                    . ${VENV}/bin/activate

                    robot robot/
                '''
            }
        }
    }

    post {
        always {
            sh '''
                cd cnf-5g-lab
                pkill -f amf_api.py || true
                pkill -f smf_api.py || true
            '''

            archiveArtifacts artifacts: 'cnf-5g-lab/*.log, cnf-5g-lab/*.html, cnf-5g-lab/*.xml', allowEmptyArchive: true
        }

        success {
            echo "✅ CNF AMF/SMF API tests PASSED"
        }

        failure {
            echo "❌ CNF AMF/SMF API tests FAILED"
        }
    }
}
